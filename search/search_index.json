{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"PyKMP \u2013 a Kamstrup meter toolset","text":"<p>This module is developed for reading out Kamstrup meters using their vendor-specific KMP protocol.</p> <p>Tested with a MULTICAL\u00ae 403, based on documentation of the protocol for the older MULTICAL\u00ae models.</p> <p>Current state: alpha \u2013 based on the documentation it \"should work\" with a MULTICAL\u00ae 30x/40x/60x, but for other models: YMMV. Pull requests welcome!</p> <p>Note</p> <p>This project is not affiliated with Kamstrup A/S, Kamstrup B.V. or any other entity of the Kamstrup corporation.</p> <p>Warning: battery consumption impact</p> <p>Please be informed about the battery consumption impact, read the battery consumption page.</p> <p>Use at your own risk.</p>"},{"location":"#features","title":"Features \u2728","text":"<p>Note that this is a library, intended primarily for development or integration.</p> <ul> <li>A bundled CLI tool to interact with the meter for testing/development purposes   with JSON format output (optional).</li> <li>Read multiple registers in one go to conserve the meter's internal battery as much   as possible.</li> <li>Having it all fully type-annotated (mypy strict, zero <code>type: ignore</code>s) should make   using this library a breeze.</li> <li>100% test coverage (library, not the tool yet).</li> <li>Ability to decode the base-10 variable length floating point values in registers   without loss of significance.</li> <li>CRC checksum verification (and adding).</li> <li>Agnostic to the direction for message encoding, ie. you could go wild and   emulate a meter using your IR optical head. \ud83e\udd13</li> </ul>"},{"location":"#license","title":"License","text":"<p>The majority of the project is Apache 2.0 licensed.</p> <p>Files deemed insignificant in terms of copyright such as configuration files are licensed under the public domain \"no rights reserved\" CC0 license.</p> <p>The repository is REUSE compliant.</p> <p>Read more on contributing in Contributing.</p>"},{"location":"battery-consumption/","title":"Battery consumption \ud83e\udeab","text":"<p>Most Kamstrup meters for heat are battery-powered. Using the optical/infrared interface will draw extra power from the battery and it may deplete sooner when using this on a regular basis.</p> <p>Extending the interval of reading should help, as well as requesting all data you need in a single request \u2013 avoid looping with just a single register ID for example.</p> <p>Reading the battery level is not (yet) possible.</p> <p>IR-circuit may only be activated with a magnet in the optical head. In addition to that, some (older) models may require periodic re-activation of the IR-circuit by pressing any button on the panel.</p>"},{"location":"contributing/","title":"Contributing","text":"<p>Your contributions, in any form, are very much welcome! \ud83d\ude4f</p> <p>When contributing to this repository with a proposed change to the code, please first discuss the change you wish to make in an issue (for bugs or features), create a discussion post in case anything is unclear, write me an email (<code>github@gertvandijk.nl</code>) or any other method with the owners of this repository before making a change.</p>"},{"location":"contributing/#getting-started-with-development","title":"Getting started with development","text":"<ol> <li> <p>Get a copy of the repository (e.g.     <code>git clone https://github.com/gertvdijk/PyKMP.git</code>) and change your current     directory in the project root.</p> </li> <li> <p>Create a clean Python 3.10.x/3.11.x virtual environment and activate it.     Suggested way is to install direnv together with     Pyenv and use the project-supplied <code>.envrc</code> (<code>direnv allow</code>).</p> <pre><code>$ direnv allow\n</code></pre> </li> <li> <p>Make sure the base Python packages such as <code>pip</code>, <code>setuptools</code> and <code>setuptools-scm</code>     are up-to-date inside this virtualenv.</p> <pre><code>$ pip install --upgrade pip setuptools setuptools-scm[toml]\n</code></pre> </li> <li> <p>This should list zero outdated packages at this point:</p> <pre><code>$ pip list --outdated\n</code></pre> </li> <li> <p>Install the project with development dependencies with this virtualenv active. E.g.:</p> <pre><code>$ pip install -e .[development]\n</code></pre> </li> <li> <p>Verify that all tests pass by running <code>pytest</code>.</p> <pre><code>$ pytest\n[...]\n==== 117 passed in 0.21s ====\n</code></pre> </li> <li> <p>Verify that you can run the <code>run-all-linters</code> script.</p> <pre><code>$ ./run-all-linters\n[...]\nEverything looks OK! \ud83c\udf89\n</code></pre> </li> <li> <p>You're ready to contribute your changes now!</p> </li> </ol>"},{"location":"contributing/#suggested-ide-vs-code","title":"Suggested IDE: VS Code","text":"<p>The repository ships with helpers for use with Microsoft Visual Studio Code. It suggests extensions, performs strict mypy type checking on the fly, visual indicators for code style (e.g. 88-chars ruler), provides a task with 'problemMatcher' to run the <code>run-all-linters</code> script and more.</p> <p>To get started, I suggest to open the local clone of the repository as Folder first, then save it as a Workspace afterwards. Any custom settings desired which aren't for all projects and neither should be part of this project can then be set to the workspace (local) level.</p> <p>In order for the extensions to work correctly, please select the Python interpreter of the virtualenv you created, e.g. <code>.direnv/python-3.11/bin/python</code>.</p> <p>Please set <code>ruff.importStrategy</code> to <code>fromEnvironment</code> in your workspace (or user) settings to use the same Ruff version as in the virtual environment. The Ruff plugin uses the bundled version by default.</p> <p>All linters and type checkers will run inside this environment created with specific versions specified rather than relying on whatever is available system-wide.</p> <p>Automatic on-save formatting</p> <p>If you like, enable automatic on-save formatting with project-provided settings using the user/profile-level setting <code>editor.formatOnSave</code>. It will run <code>black</code> for you whenever hitting Save on a file.</p>"},{"location":"contributing/#add-yourself-as-contributor","title":"Add yourself as contributor","text":"<p>In case you have some (significant) contributions and you would like to see your name in the copyright file headers invoke the <code>reuse</code> tool to do the job:</p> <pre><code>$ reuse annotate --copyright \"Your Name &lt;user@domain.tld&gt;\" path/to/file [file...]\n</code></pre> <p>This adds a line like below to the files specified.</p> <pre><code># SPDX-FileCopyrightText: 2023 Your Name &lt;user@domain.tld&gt;\n</code></pre> <p>Alternatively, you could choose to waive the copyright and just be mentioned as a non-copyright contributor by replacing <code>--copyright</code> with <code>--contributor</code>.</p> <p>This adds a line like below to the files specified.</p> <pre><code># SPDX-FileContributor: Your Name &lt;user@domain.tld&gt;\n</code></pre> <p>A use case for this are changes which are considered insignificant in terms of copyright, for example automated reformatting or changing the name of a variable.</p>"},{"location":"contributing/#pull-request-process","title":"Pull Request Process","text":"<p>Info</p> <p>The aim for this workflow is to end up with a clean git history which should be helpful for anyone else in the future (e.g. using git-blame, git-log).</p> <ol> <li>Fork the repository to your own GitHub account.</li> <li>Push the change(s) to your local fork, preferably to branch with a self-descriptive     name.     Please use a clean git commit history with descriptive commit messages and refer to     relevant issues or discussions.     In case your work was done in multiple iterations, use amending and/or an     interactive rebase to craft a set of contained commits.</li> <li>Ensure that your fork's branch is based off with latest upstream <code>develop</code> branch.     If not, fetch latest changes and rebase it.</li> <li>Run the <code>run-all-linters</code> script to ensure all code adheres to the code style, strict     typing requirements and licensing headers.</li> <li>Run <code>pytest</code> to ensure your code changes do not break current tests (adjust if     necessary) and your newly introduced lines are all covered by new/adjusted tests     (compare coverage output).</li> <li>All ready?!     Create a pull request targeting the <code>develop</code> branch.     Write a title that consicely describes the main aim of the changes in the request.     Consider to tick the \"Allow edits by maintainers\" checkbox (see below).</li> <li>Please allow the maintainer to take the time to review and test the code.     In case code changes are requested, please amend the commit(s) affected and update     the commit message(s) if necessary.</li> </ol> <p>Also imperfect PRs are welcome!</p> <p>If you're uncomfortable to rebase/amend or unsure about commit message wording or even adjusting test cases, please indicate that the maintainer is allowed to edit your pull request when creating the pull request.</p> <p>Then in the pull request description kindly request the maintainer to apply the work on that and consider to mark the pull request as draft.</p> <p>Notes:</p> <ul> <li> <p>Ideally, every single commit should be reversible and have a single responsibility.     Preparatory work leading up to an actual change should happen in separate commit(s)     to aid reviewing and having a useful git history.     Example of a well-crafted set of commits:</p> <p><code>HEAD   Implement feature X</code> \u2014 the aim of the pull request</p> <p><code>HEAD^  Refactor module Y to allow for subclassing ClassZ</code> \u2014 improvement, but preparatory change</p> <p><code>HEAD^^ Add tests for current logic in module Y</code> \u2014 not a functional change in itself, but purely preparatory to assert a before-change state is tested for.</p> </li> <li> <p>Please adhere to the following style in commit messages:</p> <ul> <li>Use present tense.</li> <li>Avoid captain obvious-only commit messages like \"Delete file x\" or     \"Update file y\", because, well, anyone can see precisely that when looking at     the diff.</li> <li>Add the reason for the change (if not obvious).     To have a why later looking at the changes is very useful, e.g. when creating     release notes or even at review time understanding for the need to include the     change.</li> </ul> </li> <li> <p>Please avoid merge commits in your pull request; use rebase instead.     Merge commits are harder to revert and to cherry-pick.</p> </li> <li>Pull requests should apply cleanly on the latest upstream <code>develop</code> branch.     Preferably, your branch should be 'fast-forwardable' in git-speak.</li> <li> <p>The maintainer is free to cherry-pick, amend and push your work in a pull request's     commits directly to any branch, effectively bypassing GitHub's pull request 'merge'     button.     Attributions will be preserved by either the commit's author field or a     <code>Co-authored-by</code> footer in the commits.</p> <p>This also enables to move forward with dependent commits in a pull request still pending discussion on the adoption of that actual feature or bug fix approach. E.g. the two commits at the bottom (<code>Update code style ...</code>, <code>Refactor module Y ...</code>) could be merged for everyone to profit from already and reducing the size of the pull request pending review as well.</p> </li> <li> <p>At the expense of the clean git history policy GPG/SSH signatures on commits by     contributors could be lost as a result of the amendments by non-authors.     If you wish to maintain your digitally verifiable signature, please take the time to     submit your pull request in a state it can be fast-forwarded and rebase whenever     the target branch is updated (which may be frequent).</p> </li> </ul>"},{"location":"getting-started/","title":"Getting started \ud83d\ude80","text":""},{"location":"getting-started/#installation","title":"Installation","text":"<p>First of all, you'll need Python 3.10+ (sorry, using modern Python features).</p> <p>Then just install <code>PyKMP</code> from PyPI, e.g.:</p> <pre><code>$ python -m venv /tmp/venv       #(1)\n$ source /tmp/venv/bin/activate  #(2)\n$ pip install -U pip setuptools  #(3)\n$ pip install PyKMP[tool]        #(4)\n</code></pre> <ol> <li> <p>Creates a 'virtual environment' using the Python built-in     'venv' module.</p> </li> <li> <p>Run this every time in a new session to activate this virtual environment.</p> </li> <li> <p>Not strictly needed, but generally a good idea to update core tools like setuptools     and pip.</p> </li> <li> <p>Install with the optional dependencies for the CLI tool by adding <code>[tool]</code>.</p> </li> </ol>"},{"location":"getting-started/#cli-tool-pykmp-tool","title":"CLI tool <code>pykmp-tool</code>","text":"<p>Let's explore some of the features by using the CLI tool first.</p> <pre><code>$ source venv/bin/activate  # activate this venv in every new session\n</code></pre> Full output of <code>pykmp-tool --help</code> <pre><code>Usage: pykmp-tool [OPTIONS] COMMAND [ARGS]...\n\nCommand line tool to request data from a Kamstrup meter.\n\nOptions:\n-d, --serial-device TEXT        The path to the serial device, e.g. the USB-\n                                to-Serial converter on '/dev/ttyUSB0'. You\n                                may want to select a stable device path in\n                                '/dev/serial/by-id/' instead.\n\n                                For connecting over TCP (e.g. with ser2net),\n                                you can use 'socket://&lt;host&gt;:&lt;port&gt;'.  [env\n                                var: PYKMP_SERIAL_DEVICE; default:\n                                /dev/ttyUSB0]\n-a, --destination-address DEC_OR_HEX\n                                Data link layer destination address. (hex or\n                                int)\n\n                                The default is set to 63 (HEAT_METER). Other\n                                known addresses: 127 (LOGGER_TOP), 191\n                                (LOGGER_BASE)\n\n                                \u26a0 The tool has only been tested with the\n                                default value.  [env var:\n                                PYKMP_DESTINATION_ADDRESS; default: 63]\n-v, --verbose                   Show more logging (twice for debug logging)\n                                [default: 0]\n--help                          Show this message and exit.\n\nCommands:\nget-register  Request register(s) of the Kamstrup meter and print the...\nget-serial    Request the serial number of a Kamstrup meter and print it.\n</code></pre> <p>Retrieve some interesting metrics (registers):</p> <pre><code>$ export PYKMP_SERIAL_DEVICE=/dev/ttyUSB0  #(1)\n$ pykmp-tool get-register \\\n--register 60 \\\n--register 68 \\\n--register 80 \\\n--register 74 \\\n--register 86 \\\n--register 87 \\\n--register 266\nGetRegister response(s):\n  60 \u2192 Heat Energy (E1) = 0.303 GJ\n  68 \u2192 Volume           = 11.388 m\u00b3\n  80 \u2192 Current Power    = 0.0 kW\n  74 \u2192 Flow             = 3 l/h\n  86 \u2192 Temp1            = 61.62 \u00b0C\n  87 \u2192 Temp2            = 54.02 \u00b0C\n 266 \u2192 E1HighRes        = 84208 Wh\n</code></pre> <ol> <li> <p>Totally optional, but here we use an environment variable for convenience instead of    <code>--serial-device /dev/ttyUSB0</code> in the command.     You just have to set (export) it once for the session.</p> <p> See <code>pykmp-tool --help</code> for how any other command line option can be set with environment variables.</p> </li> </ol> <p>Tip</p> <p>Add <code>--json</code> to get structured machine-readable output in JSON format.</p> <p>In case you run into issues...</p> <p><pre><code>$ pykmp-tool get-register --register 1002\nWARNING:pykmp.tool.__main__:Unknown register ID(s); please report this if you have more information.\nGetRegister response(s):\n1002 \u2192 &lt;unknown reg 1002&gt; = 200132 hh:mm:ss\n</code></pre> ... you may want to show more verbose logging and debug the communication by adding <code>-vv</code>:</p> <pre><code>$ pykmp-tool -vv get-register --register 1002\nDEBUG:pykmp.client:Request encoded: 803F100103EA4CB70D\nINFO:pykmp.client:Sending GetRegisterRequest...\nDEBUG:pykmp.client:Received bytes on serial: '403F1003EA2F040000030E33B2320D'\nDEBUG:pykmp.codec:Checksum verification OK [raw=3f1003ea2f040000030e33b232, crc_given=b232, crc_calculated=OK]\nDEBUG:pykmp.messages:Decoding register bytes. [raw='03EA2F040000030E33', length_min=6]\nDEBUG:pykmp.messages:Decoded register values: [id=1002, unit=47, value_bytes=040000030E33, remaining bytes=0]\nWARNING:pykmp.tool.__main__:Unknown register ID(s); please report this if you have more information.\nGetRegister response(s):\nDEBUG:pykmp.codec:Decoding parts of floating point data. [data='040000030E33', integer_length=4]\nDEBUG:pykmp.codec:Decoded floating point data: Decimal('200243') [data='040000030E33', man=200243, si=False, se=False, exp=0]\n1002 \u2192 &lt;unknown reg 1002&gt; = 200243 hh:mm:ss\n</code></pre> <p>Clearly, some registers appear undiscovered and the formatting for some units need some love. \ud83d\ude05</p> <p>So far we've only seen 'GetRegister' commands/responses. Another command is 'GetSerialNo':</p> <pre><code>$ pykmp-tool get-serial\nMeter serial is: 123456\n</code></pre>"},{"location":"getting-started/#api-examples","title":"API examples","text":"<p>To perform the above example with requesting the serial number, but then programmatically using the API:</p> <pre><code>from pykmp import GetSerialRequest, PySerialClientCommunicator\nmultical = PySerialClientCommunicator(serial_device=\"/dev/ttyUSB0\")\nresponse = multical.send_request(message=GetSerialRequest())\nprint(f\"Meter serial is: {response.serial}\")\n</code></pre> <p>And similarly, for obtaining the register data:</p> <pre><code>from pykmp import (\nREGISTERS,\nUNITS_NAMES,\nFloatCodec,\nGetRegisterRequest,\nPySerialClientCommunicator,\n)\nmultical = PySerialClientCommunicator(serial_device=\"/dev/ttyUSB0\")\nresponse = multical.send_request(\nmessage=GetRegisterRequest(registers=[60, 68, 74, 80, 86, 87, 89, 266])\n)\nfor reg in response.registers.values():\nname, unit = REGISTERS.get(reg.id_, \"?\"), UNITS_NAMES.get(reg.unit, \"?\")\nprint(f\"Register {reg.id_} ({name}) data: {FloatCodec.decode(reg.value)} {unit}\")\n</code></pre>"},{"location":"hardware-requirements/","title":"Hardware requirements","text":"<p>For most situation you would want to use the optical/infrared interface. For that, you will need an IR optical read-out head with serial (or serial-to-USB) interface.</p> <p>Using Ali-Express: 'USB to optical interface IrDA near-infrared magnetic adapter' this is confirmed working with the MULTICAL\u00ae 403 (IR head positioned upside down).</p> <p>Note that a magnet is required to enable the IR circuit, but it's not strong enough to maintain the position of the head on its own. You would still want to find a way to mount the head for a permanent installation.</p>"},{"location":"resources/","title":"KMP protocol documentation","text":"<p>Technical description of meters sometimes show a little information of the design and generic specification of the protocol. This gives some clues about device-specific registers or a graphical explanation of the OSI layers. However, important details are in a separate document which is seemingly only available under NDA. \ud83d\ude22</p> <p>12.3 Data protocol</p> <p>Utilities and other relevant companies who want to develop their own communication driver for the KMP protocol can order a demonstration program in C# (.net based) as well as a detailed protocol description (in English language).</p> <p>Some more clues can be found in related communcation interfaces like MODBUS where registers are listed: Modbus/KMP TCP/IP module for MULTICAL\u00ae 603 Data sheet</p> <p>Nice people from the MeterLogger project have left some notes for the development of the MeterLogger for Kamstrup meters.</p> <p>Access to the vendor's own software to communicate with the meters ('Metertool HCW') is not available (or at least not for free).</p>"},{"location":"ser2net/","title":"Connecting over the network (ser2net)","text":"<p>It's not always practical to communicate with the meter via (USB-to-)serial. Using ser2net on a (small) device close to the meter you can expose it on your network.</p> <p>Example configuration:</p> <pre><code>connection: &amp;mykamstrup\naccepter: tcp,2002\nconnector: &gt;-\nserialdev,\n/dev/serial/by-id/usb-Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0,\n1200n82\noptions:\nmax-connections: 1\n</code></pre> <p>This above example uses TCP port 2002 on the host. A connection can be made from any other host using the <code>socket://</code> URL handler with PySerial like this:</p> <pre><code>$ pykmp-tool --serial-device socket://hostname:2002 [...]\n</code></pre> <p>Or use the environment variable to not having to specify it in every command:</p> <pre><code>$ export PYKMP_SERIAL_DEVICE=socket://hostname:2002\n</code></pre>"},{"location":"store-graph-metrics/","title":"Store and graph metrics \ud83d\udcca","text":"<p>That's not really in scope of this library, but a separate project could (should) use this.</p> <p>Anyway, it's planned to build that too! <code>&lt;img src=\"under-construction.gif\"&gt;</code></p> <p>In the meantime, you could try to automate things by getting output in JSON format using <code>--json</code>:</p> <pre><code>$ pykmp-tool get-register --json [...]\n</code></pre>"},{"location":"thanks/","title":"Thanks to... \ud83d\ude4f","text":"<p>This project's existence is mainly thanks to all the information and regarding the KMP protocol people have put online over the years.</p> <p>The MeterLogger project have left some notesfor the development of the MeterLogger for Kamstrup meters. Also the work by Poul-Henning Kamp (and later Ronald van der Meer) in GitHub: <code>ronaldvdmeer/multical402-4-domoticz</code> was inspiring to get started with exploring possibilities and testing my hardware.</p> <p>Finally, also a shoutout to the Dutch community Tweakers where a forum topic pointed out the possibilities integrating these MULTICAL\u00ae meters (as provided by Dutch utilities) to non-cloud smart home. GoT: Kamstrup Multical 402 stadsverwarmingsmeter RPI3+IR-kop</p>"},{"location":"troubleshooting/","title":"Troubleshooting","text":""},{"location":"troubleshooting/#unable-to-run-the-tool-pykmp-tool-command-not-found","title":"Unable to run the tool <code>pykmp-tool: command not found</code>","text":"<p>Using a Python package manager (e.g. pip) should ensure the entry point should be installed somewhere in a directory that's on your PATH, but apparently that failed.</p> <p>As an alternative, you can try to substitute <code>pykmp-tool</code> with <code>python -m pykmp.tool</code>.</p>"},{"location":"troubleshooting/#unable-to-get-a-reading-connection-timeout","title":"Unable to get a reading (connection timeout)","text":"<ul> <li>Make sure your IR head has an included magnet that activates the meter's IR circuit.   If in doubt, activate it by pressing any button and try to get a reading while the   display is active.</li> <li>Make sure the RX/TX is aligned with the meter.   It's most if not all cases the IR head has to be placed in upside-down position.</li> <li>Try to re-align around the position of the IR optical head while keeping a command   running in a loop in your shell.</li> </ul>"}]}